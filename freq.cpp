#include "freq.h"

#ifdef ARDUINO
    #include <avr/pgmspace.h>
#else
    #define PROGMEM
#endif

uint32_t getNoteFrequency(
    uint8_t note,
    int8_t cents)
{
    const PROGMEM static uint16_t frequencyTable[1200] = {
        16352, // C-0
        16361,
        16371,
        16380,
        16389,
        16399,
        16408,
        16418,
        16427,
        16437,
        16446,
        16456,
        16465,
        16475,
        16484,
        16494,
        16503,
        16513,
        16522,
        16532,
        16542,
        16551,
        16561,
        16570,
        16580,
        16589,
        16599,
        16609,
        16618,
        16628,
        16637,
        16647,
        16657,
        16666,
        16676,
        16686,
        16695,
        16705,
        16714,
        16724,
        16734,
        16743,
        16753,
        16763,
        16773,
        16782,
        16792,
        16802,
        16811,
        16821,
        16831,
        16840,
        16850,
        16860,
        16870,
        16879,
        16889,
        16899,
        16909,
        16918,
        16928,
        16938,
        16948,
        16958,
        16967,
        16977,
        16987,
        16997,
        17007,
        17016,
        17026,
        17036,
        17046,
        17056,
        17066,
        17076,
        17085,
        17095,
        17105,
        17115,
        17125,
        17135,
        17145,
        17155,
        17165,
        17174,
        17184,
        17194,
        17204,
        17214,
        17224,
        17234,
        17244,
        17254,
        17264,
        17274,
        17284,
        17294,
        17304,
        17314,
        17324, // C#0
        17334,
        17344,
        17354,
        17364,
        17374,
        17384,
        17394,
        17404,
        17414,
        17424,
        17434,
        17444,
        17454,
        17465,
        17475,
        17485,
        17495,
        17505,
        17515,
        17525,
        17535,
        17545,
        17556,
        17566,
        17576,
        17586,
        17596,
        17606,
        17617,
        17627,
        17637,
        17647,
        17657,
        17668,
        17678,
        17688,
        17698,
        17708,
        17719,
        17729,
        17739,
        17749,
        17760,
        17770,
        17780,
        17790,
        17801,
        17811,
        17821,
        17832,
        17842,
        17852,
        17862,
        17873,
        17883,
        17893,
        17904,
        17914,
        17924,
        17935,
        17945,
        17956,
        17966,
        17976,
        17987,
        17997,
        18008,
        18018,
        18028,
        18039,
        18049,
        18060,
        18070,
        18080,
        18091,
        18101,
        18112,
        18122,
        18133,
        18143,
        18154,
        18164,
        18175,
        18185,
        18196,
        18206,
        18217,
        18227,
        18238,
        18248,
        18259,
        18269,
        18280,
        18291,
        18301,
        18312,
        18322,
        18333,
        18343,
        18354, // D-0
        18365,
        18375,
        18386,
        18397,
        18407,
        18418,
        18428,
        18439,
        18450,
        18460,
        18471,
        18482,
        18492,
        18503,
        18514,
        18524,
        18535,
        18546,
        18557,
        18567,
        18578,
        18589,
        18600,
        18610,
        18621,
        18632,
        18643,
        18653,
        18664,
        18675,
        18686,
        18696,
        18707,
        18718,
        18729,
        18740,
        18751,
        18761,
        18772,
        18783,
        18794,
        18805,
        18816,
        18827,
        18837,
        18848,
        18859,
        18870,
        18881,
        18892,
        18903,
        18914,
        18925,
        18936,
        18947,
        18957,
        18968,
        18979,
        18990,
        19001,
        19012,
        19023,
        19034,
        19045,
        19056,
        19067,
        19078,
        19089,
        19100,
        19111,
        19122,
        19133,
        19145,
        19156,
        19167,
        19178,
        19189,
        19200,
        19211,
        19222,
        19233,
        19244,
        19255,
        19267,
        19278,
        19289,
        19300,
        19311,
        19322,
        19333,
        19345,
        19356,
        19367,
        19378,
        19389,
        19401,
        19412,
        19423,
        19434,
        19445, // D#0
        19457,
        19468,
        19479,
        19490,
        19502,
        19513,
        19524,
        19536,
        19547,
        19558,
        19569,
        19581,
        19592,
        19603,
        19615,
        19626,
        19637,
        19649,
        19660,
        19671,
        19683,
        19694,
        19706,
        19717,
        19728,
        19740,
        19751,
        19762,
        19774,
        19785,
        19797,
        19808,
        19820,
        19831,
        19843,
        19854,
        19866,
        19877,
        19888,
        19900,
        19911,
        19923,
        19934,
        19946,
        19958,
        19969,
        19981,
        19992,
        20004,
        20015,
        20027,
        20038,
        20050,
        20062,
        20073,
        20085,
        20096,
        20108,
        20120,
        20131,
        20143,
        20154,
        20166,
        20178,
        20189,
        20201,
        20213,
        20224,
        20236,
        20248,
        20259,
        20271,
        20283,
        20295,
        20306,
        20318,
        20330,
        20342,
        20353,
        20365,
        20377,
        20389,
        20400,
        20412,
        20424,
        20436,
        20448,
        20459,
        20471,
        20483,
        20495,
        20507,
        20519,
        20530,
        20542,
        20554,
        20566,
        20578,
        20590,
        20602, // E-0
        20614,
        20626,
        20637,
        20649,
        20661,
        20673,
        20685,
        20697,
        20709,
        20721,
        20733,
        20745,
        20757,
        20769,
        20781,
        20793,
        20805,
        20817,
        20829,
        20841,
        20853,
        20865,
        20877,
        20889,
        20901,
        20913,
        20926,
        20938,
        20950,
        20962,
        20974,
        20986,
        20998,
        21010,
        21022,
        21035,
        21047,
        21059,
        21071,
        21083,
        21095,
        21108,
        21120,
        21132,
        21144,
        21156,
        21169,
        21181,
        21193,
        21205,
        21218,
        21230,
        21242,
        21254,
        21267,
        21279,
        21291,
        21304,
        21316,
        21328,
        21341,
        21353,
        21365,
        21378,
        21390,
        21402,
        21415,
        21427,
        21439,
        21452,
        21464,
        21477,
        21489,
        21501,
        21514,
        21526,
        21539,
        21551,
        21564,
        21576,
        21589,
        21601,
        21613,
        21626,
        21638,
        21651,
        21663,
        21676,
        21689,
        21701,
        21714,
        21726,
        21739,
        21751,
        21764,
        21776,
        21789,
        21802,
        21814,
        21827, // F-0
        21839,
        21852,
        21865,
        21877,
        21890,
        21903,
        21915,
        21928,
        21941,
        21953,
        21966,
        21979,
        21991,
        22004,
        22017,
        22029,
        22042,
        22055,
        22068,
        22080,
        22093,
        22106,
        22119,
        22131,
        22144,
        22157,
        22170,
        22183,
        22195,
        22208,
        22221,
        22234,
        22247,
        22260,
        22273,
        22285,
        22298,
        22311,
        22324,
        22337,
        22350,
        22363,
        22376,
        22389,
        22402,
        22414,
        22427,
        22440,
        22453,
        22466,
        22479,
        22492,
        22505,
        22518,
        22531,
        22544,
        22557,
        22570,
        22583,
        22596,
        22610,
        22623,
        22636,
        22649,
        22662,
        22675,
        22688,
        22701,
        22714,
        22727,
        22741,
        22754,
        22767,
        22780,
        22793,
        22806,
        22819,
        22833,
        22846,
        22859,
        22872,
        22885,
        22899,
        22912,
        22925,
        22938,
        22952,
        22965,
        22978,
        22991,
        23005,
        23018,
        23031,
        23045,
        23058,
        23071,
        23085,
        23098,
        23111,
        23125, // F#0
        23138,
        23151,
        23165,
        23178,
        23192,
        23205,
        23218,
        23232,
        23245,
        23259,
        23272,
        23285,
        23299,
        23312,
        23326,
        23339,
        23353,
        23366,
        23380,
        23393,
        23407,
        23420,
        23434,
        23447,
        23461,
        23475,
        23488,
        23502,
        23515,
        23529,
        23542,
        23556,
        23570,
        23583,
        23597,
        23611,
        23624,
        23638,
        23652,
        23665,
        23679,
        23693,
        23706,
        23720,
        23734,
        23747,
        23761,
        23775,
        23789,
        23802,
        23816,
        23830,
        23844,
        23857,
        23871,
        23885,
        23899,
        23913,
        23926,
        23940,
        23954,
        23968,
        23982,
        23996,
        24009,
        24023,
        24037,
        24051,
        24065,
        24079,
        24093,
        24107,
        24121,
        24135,
        24148,
        24162,
        24176,
        24190,
        24204,
        24218,
        24232,
        24246,
        24260,
        24274,
        24288,
        24302,
        24316,
        24330,
        24345,
        24359,
        24373,
        24387,
        24401,
        24415,
        24429,
        24443,
        24457,
        24471,
        24486,
        24500, // G-0
        24514,
        24528,
        24542,
        24556,
        24571,
        24585,
        24599,
        24613,
        24627,
        24642,
        24656,
        24670,
        24684,
        24699,
        24713,
        24727,
        24741,
        24756,
        24770,
        24784,
        24799,
        24813,
        24827,
        24842,
        24856,
        24870,
        24885,
        24899,
        24914,
        24928,
        24942,
        24957,
        24971,
        24986,
        25000,
        25015,
        25029,
        25043,
        25058,
        25072,
        25087,
        25101,
        25116,
        25130,
        25145,
        25159,
        25174,
        25188,
        25203,
        25218,
        25232,
        25247,
        25261,
        25276,
        25291,
        25305,
        25320,
        25334,
        25349,
        25364,
        25378,
        25393,
        25408,
        25422,
        25437,
        25452,
        25466,
        25481,
        25496,
        25511,
        25525,
        25540,
        25555,
        25570,
        25584,
        25599,
        25614,
        25629,
        25644,
        25658,
        25673,
        25688,
        25703,
        25718,
        25733,
        25747,
        25762,
        25777,
        25792,
        25807,
        25822,
        25837,
        25852,
        25867,
        25882,
        25897,
        25912,
        25927,
        25942,
        25957, // G#0
        25972,
        25987,
        26002,
        26017,
        26032,
        26047,
        26062,
        26077,
        26092,
        26107,
        26122,
        26137,
        26152,
        26167,
        26182,
        26198,
        26213,
        26228,
        26243,
        26258,
        26273,
        26289,
        26304,
        26319,
        26334,
        26349,
        26365,
        26380,
        26395,
        26410,
        26426,
        26441,
        26456,
        26471,
        26487,
        26502,
        26517,
        26533,
        26548,
        26563,
        26579,
        26594,
        26609,
        26625,
        26640,
        26655,
        26671,
        26686,
        26702,
        26717,
        26733,
        26748,
        26763,
        26779,
        26794,
        26810,
        26825,
        26841,
        26856,
        26872,
        26887,
        26903,
        26919,
        26934,
        26950,
        26965,
        26981,
        26996,
        27012,
        27028,
        27043,
        27059,
        27074,
        27090,
        27106,
        27121,
        27137,
        27153,
        27168,
        27184,
        27200,
        27216,
        27231,
        27247,
        27263,
        27279,
        27294,
        27310,
        27326,
        27342,
        27357,
        27373,
        27389,
        27405,
        27421,
        27437,
        27452,
        27468,
        27484,
        27500, // A-0
        27516,
        27532,
        27548,
        27564,
        27580,
        27595,
        27611,
        27627,
        27643,
        27659,
        27675,
        27691,
        27707,
        27723,
        27739,
        27755,
        27771,
        27787,
        27803,
        27820,
        27836,
        27852,
        27868,
        27884,
        27900,
        27916,
        27932,
        27948,
        27965,
        27981,
        27997,
        28013,
        28029,
        28045,
        28062,
        28078,
        28094,
        28110,
        28127,
        28143,
        28159,
        28175,
        28192,
        28208,
        28224,
        28240,
        28257,
        28273,
        28289,
        28306,
        28322,
        28339,
        28355,
        28371,
        28388,
        28404,
        28420,
        28437,
        28453,
        28470,
        28486,
        28503,
        28519,
        28536,
        28552,
        28569,
        28585,
        28602,
        28618,
        28635,
        28651,
        28668,
        28684,
        28701,
        28718,
        28734,
        28751,
        28767,
        28784,
        28801,
        28817,
        28834,
        28851,
        28867,
        28884,
        28901,
        28917,
        28934,
        28951,
        28967,
        28984,
        29001,
        29018,
        29034,
        29051,
        29068,
        29085,
        29102,
        29118,
        29135, // A#0
        29152,
        29169,
        29186,
        29203,
        29220,
        29236,
        29253,
        29270,
        29287,
        29304,
        29321,
        29338,
        29355,
        29372,
        29389,
        29406,
        29423,
        29440,
        29457,
        29474,
        29491,
        29508,
        29525,
        29542,
        29559,
        29576,
        29593,
        29610,
        29627,
        29645,
        29662,
        29679,
        29696,
        29713,
        29730,
        29747,
        29765,
        29782,
        29799,
        29816,
        29833,
        29851,
        29868,
        29885,
        29902,
        29920,
        29937,
        29954,
        29972,
        29989,
        30006,
        30024,
        30041,
        30058,
        30076,
        30093,
        30110,
        30128,
        30145,
        30163,
        30180,
        30198,
        30215,
        30232,
        30250,
        30267,
        30285,
        30302,
        30320,
        30337,
        30355,
        30372,
        30390,
        30408,
        30425,
        30443,
        30460,
        30478,
        30496,
        30513,
        30531,
        30548,
        30566,
        30584,
        30601,
        30619,
        30637,
        30654,
        30672,
        30690,
        30708,
        30725,
        30743,
        30761,
        30779,
        30796,
        30814,
        30832,
        30850,
        30868, // B-0
        30886,
        30903,
        30921,
        30939,
        30957,
        30975,
        30993,
        31011,
        31029,
        31047,
        31064,
        31082,
        31100,
        31118,
        31136,
        31154,
        31172,
        31190,
        31208,
        31226,
        31244,
        31262,
        31281,
        31299,
        31317,
        31335,
        31353,
        31371,
        31389,
        31407,
        31425,
        31444,
        31462,
        31480,
        31498,
        31516,
        31535,
        31553,
        31571,
        31589,
        31607,
        31626,
        31644,
        31662,
        31681,
        31699,
        31717,
        31736,
        31754,
        31772,
        31791,
        31809,
        31827,
        31846,
        31864,
        31883,
        31901,
        31919,
        31938,
        31956,
        31975,
        31993,
        32012,
        32030,
        32049,
        32067,
        32086,
        32104,
        32123,
        32141,
        32160,
        32179,
        32197,
        32216,
        32234,
        32253,
        32272,
        32290,
        32309,
        32328,
        32346,
        32365,
        32384,
        32402,
        32421,
        32440,
        32459,
        32477,
        32496,
        32515,
        32534,
        32552,
        32571,
        32590,
        32609,
        32628,
        32647,
        32665,
        32684
    };

    int8_t octave;
    uint32_t baseFrequency;
    uint32_t multiplier;
    int index;

    if ((note == 0) && (cents < 0))
        return 0;

    if (note > 127)
        return 0;

    index = (note * 100) + cents;
    octave = (index / 1200) - 1;
    index %= 1200;

//    printf("Index %d octave %d\n", index, octave);

#ifdef ARDUINO
    baseFrequency = pgm_read_word_near(frequencyTable + index);
#else
    baseFrequency = frequencyTable[index];
#endif

    if (octave >= 0) {
        multiplier = 1 << octave;
        return baseFrequency * multiplier;
    } else {
        return baseFrequency / 2;
    }
}

#ifndef ARDUINO
#include <stdio.h>
int main()
{
    printf("%d\n", getNoteFrequency(0, -1));
    printf("%d\n", getNoteFrequency(0, 0));
    printf("%d\n", getNoteFrequency(0, 1));

    printf("%d\n", getNoteFrequency(24, -1));
    printf("%d\n", getNoteFrequency(24, 0));
    printf("%d\n", getNoteFrequency(24, 1));

    printf("%d\n", getNoteFrequency(127, -100));
    printf("%d\n", getNoteFrequency(127, 0));
    printf("%d\n", getNoteFrequency(127, 100));
}
#endif

